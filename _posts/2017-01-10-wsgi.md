---
layout: post
title: "WSGI理解"
description: ""
category: 
tags: []
---
{% include JB/setup %}

**What's WSGI**

---

Web服务器网关接口(Python Web Server Gateway Interface，缩写为WSGI)是为Python语言定义的Web服务器和Web应用程序或框架之间的一种简单而通用的接口。自从WSGI被开发出来以后，许多其它语言中也出现了类似接口。WSGI是作为Web服务器与Web应用程序或应用框架之间的一种低级别的接口，以提升可移植Web应用开发的共同点。WSGI是基于现存的CGI标准而设计的。

WSGI区分为两个部份：一为“服务器”或“网关”，另一为“应用程序”或“应用框架”。在处理一个WSGI请求时，服务器会为应用程序提供环境资讯及一个回呼函数(Callback Function)。当应用程序完成处理请求后，透过前述的回呼函数，将结果回传给服务器。所谓的 WSGI 中间件同时实现了API的两方，因此可以在WSGI服务和WSGI应用之间起调解作用：从WSGI服务器的角度来说，中间件扮演应用程序，而从应用程序的角度来说，中间件扮演服务器。“中间件”组件可以执行以下功能：

- 重写环境变量后，根据目标URL，将请求消息路由到不同的应用对象。

- 允许在一个进程中同时运行多个应用程序或应用框架。

- 负载均衡和远程处理，通过在网络上转发请求和响应消息。

- 进行内容后处理，例如应用XSLT样式表。

WSGI没有官方的实现, 因为WSGI更像一个协议。只要遵照这些协议,WSGI应用(Application)都可以在任何服务器(Server)上运行, 反之亦然。WSGI就是Python的CGI包装，相对于Fastcgi是PHP的CGI包装。

WSGI将 web 组件分为三类： web服务器，web中间件,web应用程序， wsgi基本处理模式为 ： WSGI Server -> (WSGI Middleware)* -> WSGI Application 。

![wsgi](https://raw.githubusercontent.com/yuzujin/yuzujin.github.com/master/_images/wsgi.jpg)


**WSGI Server/gateway**

---

wsgi server可以理解为一个符合wsgi规范的web server，接收request请求，封装一系列环境变量，按照wsgi规范调用注册的wsgi app，最后将response返回给客户端。文字很难解释清楚wsgi server到底是什么东西，以及做些什么事情，最直观的方式还是看wsgi server的实现代码。以python自带的wsgiref为例，wsgiref是按照wsgi规范实现的一个简单wsgi server。

Python 2.5和更高版本带有一个WSGI服务器: wsgiref。

大致流程如下：

- 服务器创建socket，监听端口，等待客户端连接。

- 当有请求来时，服务器解析客户端信息放到环境变量environ中，并调用绑定的handler来处理请求。

- handler解析这个http请求，将请求信息例如method，path等放到environ中。

- wsgi handler再将一些服务器端信息也放到environ中，最后服务器信息，客户端信息，本次请求信息全部都保存到了环境变量environ中。

- wsgi handler 调用注册的wsgi app，并将environ和回调函数传给wsgi app

- wsgi app 将reponse header/status/body 回传给wsgi handler

- 最终handler还是通过socket将response信息塞回给客户端。


**Application Interface**

---

WSGI应用程序接口被实现为callable对象：一个函数、一个方法、一个类或者一个实现了object.__call__()方法的实例，这个callable对象必须能够：

1.接受两个参数

  - 一个包含类CGI变量的字典 environ
  - 一个被应用用来发送HTTP状态码/信息和HTTP头部信息给服务器的回调函数 start_response

2.将响应内容以字符串迭代器的形式发给服务器

应用程序的框架如下：

    # The application interface is a callable object
    
    # It accepts two arguments:
    # environ points to a dictionary containing CGI like environment
    # variables which is populated by the server for each
    # received request from the client；
    # start_response is a callback function supplied by the server
    # which takes the HTTP status and headers as arguments
    def application ( environ, start_response ):
        # Build the response body possibly
        # using the supplied environ dictionary
        response_body = 'Request method: %s' % environ['REQUEST_METHOD']

        # HTTP response code and message
        status = '200 OK'

        # HTTP headers expected by the client
        # They must be wrapped as a list of tupled pairs:
        # [(Header name, Header value)].
        response_headers = [
            ('Content-Type', 'text/plain'),
            ('Content-Length', str(len(response_body)))
        ]
  
        # Send them to the server using the supplied function
        start_response(status, response_headers)

        # Return the response body. Notice it is wrapped
        # in a list although it could be any iterable.
        return [response_body]


